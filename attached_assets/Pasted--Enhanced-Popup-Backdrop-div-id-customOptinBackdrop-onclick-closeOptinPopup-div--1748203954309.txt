<!-- Enhanced Popup & Backdrop -->
<div id="customOptinBackdrop" onclick="closeOptinPopup()"></div>
<div id="customOptinForm">
  <span class="close-btn" onclick="closeOptinPopup()">Ã—</span>
  <div id="popupIframeContainer">
    <iframe
      id="popupFormFrame"
      src=""
      style="
        width: 100%;
        height: 340px;
        border: none;
        border-radius: 6px;
        overflow: hidden;
      "
      scrolling="no"
      allowfullscreen
      title="Get Access Form"
    ></iframe>
  </div>
</div>

<script>
  // Enhanced popup functionality with slug tracking
  function getSlugFromUrl() {
    const parts = window.location.pathname.split('/');
    return parts[parts.length - 1] || "unknown";
  }

  function openOptinPopup() {
    const slug = getSlugFromUrl();
    const baseFormUrl = "https://app.makerexpress3d.com/widget/form/yZsYJQfelidUiq28ij5v";
    
    // Build URL with tracking parameters
    const url = new URL(baseFormUrl);
    url.searchParams.set('listing', slug);
    url.searchParams.set('utm_source', 'directory');
    url.searchParams.set('utm_medium', 'popup');
    url.searchParams.set('utm_campaign', slug);

    // Set iframe source and show popup
    document.getElementById("popupFormFrame").src = url.toString();
    document.getElementById("customOptinBackdrop").style.display = "block";
    document.getElementById("customOptinForm").style.display = "block";
    
    // Prevent body scroll when popup is open
    document.body.style.overflow = "hidden";
    
    // Add escape key listener
    document.addEventListener('keydown', handleEscapeKey);
  }

  function closeOptinPopup() {
    document.getElementById("customOptinBackdrop").style.display = "none";
    document.getElementById("customOptinForm").style.display = "none";
    
    // Restore body scroll
    document.body.style.overflow = "auto";
    
    // Remove escape key listener
    document.removeEventListener('keydown', handleEscapeKey);
    
    // Clear iframe source to stop any ongoing processes
    setTimeout(() => {
      document.getElementById("popupFormFrame").src = "";
    }, 300);
  }

  function handleEscapeKey(event) {
    if (event.key === 'Escape') {
      closeOptinPopup();
    }
  }

  function insertAccessButton() {
    const priceContainer = document.querySelector(".ecomm-price-desktop-container");
    if (!priceContainer || document.querySelector(".trigger-optin-btn")) return;

    const btn = document.createElement("button");
    btn.className = "trigger-optin-btn";
    btn.textContent = "Get More Info";
    btn.onclick = openOptinPopup;

    priceContainer.parentNode.insertBefore(btn, priceContainer.nextSibling);
  }

  // Initialize popup system
  document.addEventListener("DOMContentLoaded", insertAccessButton);
  
  // Watch for dynamic content changes
  const observer = new MutationObserver(insertAccessButton);
  observer.observe(document.body, { 
    childList: true, 
    subtree: true 
  });

  // Global popup functions for external access
  window.openOptinPopup = openOptinPopup;
  window.closeOptinPopup = closeOptinPopup;
</script>