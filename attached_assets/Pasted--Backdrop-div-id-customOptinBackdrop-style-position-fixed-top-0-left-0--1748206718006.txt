<!-- Backdrop -->
<div id="customOptinBackdrop" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: none;
  z-index: 9998;
"></div>

<!-- Popup Container -->
<div id="customOptinForm" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 50px;
  border-radius: 10px;
  width: 100%;
  max-width: 740px;
  height: 440px;
  box-sizing: border-box;
  overflow: hidden;
  z-index: 9999;
">

  <!-- Close Button (Inside Top-Right Corner) -->
  <span onclick="closeOptinPopup()" style="
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    background-color: #000;
    color: #fff;
    border-radius: 50%;
    font-size: 20px;
    font-weight: bold;
    line-height: 36px;
    text-align: center;
    cursor: pointer;
    z-index: 10000;
  ">Ã—</span>

  <!-- Custom Iframe Container -->
  <div id="popupIframeContainer" style="width: 100%; height: 100%;">
    <iframe
      id="popupFormFrame"
      src=""
      style="
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 6px;
        display: block;
      "
      scrolling="no"
      allowfullscreen
    ></iframe>
  </div>
</div>

<script>
  // Enhanced popup functionality with slug tracking
  function getSlugFromUrl() {
    const parts = window.location.pathname.split('/');
    return parts[parts.length - 1] || "unknown";
  }

  function openOptinPopup() {
    const slug = getSlugFromUrl();
    const formUrl = "https://app.makerexpress3d.com/widget/form/yZsYJQfelidUiq28ij5v?listing=" + encodeURIComponent(slug) + "&utm_source=directory";

    document.getElementById("popupFormFrame").src = formUrl;
    document.getElementById("customOptinBackdrop").style.display = "block";
    document.getElementById("customOptinForm").style.display = "block";
  }

  function closeOptinPopup() {
    document.getElementById("customOptinBackdrop").style.display = "none";
    document.getElementById("customOptinForm").style.display = "none";
  }

  function insertAccessButton() {
    const priceContainer = document.querySelector(".ecomm-price-desktop-container");
    if (!priceContainer || document.querySelector(".trigger-optin-btn")) return;

    const btn = document.createElement("button");
    btn.className = "trigger-optin-btn";
    btn.textContent = "Get More Info";
    btn.onclick = openOptinPopup;

    priceContainer.parentNode.insertBefore(btn, priceContainer.nextSibling);
  }

  document.addEventListener("DOMContentLoaded", insertAccessButton);
  new MutationObserver(insertAccessButton).observe(document.body, { childList: true, subtree: true });

  window.openOptinPopup = openOptinPopup;
  window.closeOptinPopup = closeOptinPopup;
</script>