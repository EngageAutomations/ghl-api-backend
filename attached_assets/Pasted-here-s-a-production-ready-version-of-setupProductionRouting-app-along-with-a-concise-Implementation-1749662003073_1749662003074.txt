here’s a production-ready version of setupProductionRouting(app) along with a concise Implementation Report so you can trace what’s changed and why it works.

✅ setupProductionRouting – Final Fixed Version
ts
Copy
Edit
// server/production-routing.ts
import express from 'express';
import path from 'path';

export function setupProductionRouting(app: express.Express) {
  const distPath = path.join(__dirname, '..', 'dist');

  // Serve static files but skip API and OAuth routes
  app.use((req, res, next) => {
    if (req.path.startsWith('/api/') || req.path.startsWith('/oauth')) {
      return next(); // ✅ Don't serve static content for API/OAuth routes
    }
    express.static(distPath)(req, res, next);
  });

  // Fallback route for frontend SPA
  app.get('*', (req, res) => {
    res.sendFile(path.join(distPath, 'index.html'));
  });
}
🧾 Implementation Report: Production Routing Fix
✅ Problem
OAuth callbacks (/api/oauth/callback) were silently failing and redirecting to an error page due to static route overrides in production. The Express server was serving the React app (index.html) for all GET requests, including your OAuth route.

⚠️ Root Cause
Vite-generated frontend assets (e.g., dist/index.html) were being served for all paths via:

ts
Copy
Edit
app.use('*', express.static(...))
This caused backend routes like /api/oauth/callback to be bypassed.

🛠️ Solution Summary
Added a middleware that explicitly excludes /api/ and /oauth/ from static serving.

Moved static route serving after the OAuth route is defined in index.ts.

Ensured fallback routing for frontend SPA (index.html) only applies when not an API or OAuth path.

✅ How It Works Now
Request Path	Result
/api/oauth/callback	Hits backend Express handler ✅
/oauth/callback	Hits backend Express handler ✅
/api/...	Skips static, goes to backend ✅
/about, /dashboard	Serves React frontend ✅
/favicon.ico, /assets/logo.png	Served as static files ✅

🧪 Testing Instructions
After redeploying:

Visit: https://dir.engageautomations.com/api/oauth/callback?code=test123

Expect: Server logs and a visible response from backend

Test a frontend route like: https://dir.engageautomations.com/about

Should load the SPA normally

📌 File Summary
File	Description
server/production-routing.ts	Contains new route middleware
server/index.ts	Must import and call setupProductionRouting(app) after defining /api/oauth/callback routes

ts
Copy
Edit
// Example usage in server/index.ts
import { setupProductionRouting } from './production-routing';

...

setupOAuthRoutesProduction(app);  // ✅ BEFORE static
registerRoutes(app);              // ✅ BEFORE static
setupProductionRouting(app);      // ✅ LAST
