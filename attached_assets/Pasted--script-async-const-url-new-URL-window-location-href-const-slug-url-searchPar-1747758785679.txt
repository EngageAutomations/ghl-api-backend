<script>
(async () => {
  const url = new URL(window.location.href);
  const slug = url.searchParams.get("slug") || window.location.pathname.split("/").pop();
  if (!slug) return;

  const res = await fetch(`https://your-replit-api.com/api/listings/${slug}`);
  const listing = await res.json();

  const formUrl = listing.embedFormUrl || "https://link.engageautomations.com/widget/form/YOUR_FORM_ID";
  const formId = formUrl.split("/").pop();

  const fields = {
    listing_title: listing.title,
    listing_id: listing.slug,
    category: listing.category,
    utm_source: "directory",
    utm_campaign: listing.directoryName,
  };

  const searchParams = new URLSearchParams(window.location.search);
  for (const [key, value] of Object.entries(fields)) {
    searchParams.set(key, value);
  }
  window.history.replaceState({}, "", window.location.pathname + "?" + searchParams.toString());

  const iframe = document.createElement("iframe");
  iframe.src = formUrl;
  iframe.id = `inline-${formId}`;
  iframe.title = "Listing Contact Form";
  iframe.style = "width:100%;height:100%;border:none;border-radius:3px";
  iframe.setAttribute("data-layout", "{'id':'INLINE'}");
  iframe.setAttribute("data-trigger-type", "alwaysShow");
  iframe.setAttribute("data-trigger-value", "");
  iframe.setAttribute("data-activation-type", "alwaysActivated");
  iframe.setAttribute("data-activation-value", "");
  iframe.setAttribute("data-deactivation-type", "neverDeactivate");
  iframe.setAttribute("data-deactivation-value", "");
  iframe.setAttribute("data-form-name", listing.title || "Dynamic Listing Form");
  iframe.setAttribute("data-height", "1124");
  iframe.setAttribute("data-layout-iframe-id", `inline-${formId}`);
  iframe.setAttribute("data-form-id", formId);

  document.body.appendChild(iframe);

  const ghlScript = document.createElement("script");
  ghlScript.src = "https://link.engageautomations.com/js/form_embed.js";
  document.body.appendChild(ghlScript);
})();
</script>
