<!DOCTYPE html>
<html>
<head>
    <title>OAuth Flow Test - Complete</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>OAuth Flow Complete Test</h1>
    
    <div class="test-section">
        <h3>1. Test OAuth Authorization URL Generation</h3>
        <button onclick="testAuthUrl()">Generate OAuth URL</button>
        <div id="authResult"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Test OAuth Callback Handling</h3>
        <button onclick="testCallback()">Test Callback with Mock Code</button>
        <div id="callbackResult"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Test Token Exchange Endpoint</h3>
        <button onclick="testTokenExchange()">Test Token Exchange</button>
        <div id="tokenResult"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Live OAuth Flow</h3>
        <button onclick="startLiveOAuth()">Start Live OAuth Flow</button>
        <div id="liveResult"></div>
    </div>

    <script>
        function testAuthUrl() {
            const clientId = '67472ecce8b57dd9eda067a8';
            const redirectUri = 'https://dir.engageautomations.com/';
            const state = 'test_' + Date.now();
            const scopes = [
                'products/prices.write',
                'products/prices.readonly', 
                'products/collection.write',
                'products/collection.readonly',
                'medias.write',
                'medias.readonly',
                'locations.readonly',
                'contacts.readonly',
                'contacts.write'
            ];
            
            const authUrl = new URL('https://marketplace.leadconnectorhq.com/oauth/chooselocation');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', clientId);
            authUrl.searchParams.set('redirect_uri', redirectUri);
            authUrl.searchParams.set('scope', scopes.join(' '));
            authUrl.searchParams.set('state', state);
            
            const result = document.getElementById('authResult');
            result.innerHTML = `
                <div class="result success">
                    <strong>✓ OAuth URL Generated Successfully</strong><br>
                    <small>Client ID: ${clientId}</small><br>
                    <small>Redirect URI: ${redirectUri}</small><br>
                    <small>Scopes: ${scopes.length} permissions</small><br>
                    <small>State: ${state}</small><br><br>
                    <a href="${authUrl.toString()}" target="_blank">Click to test OAuth flow</a>
                </div>
            `;
        }
        
        function testCallback() {
            // Simulate callback URL parameters
            const mockCode = 'mock_auth_code_' + Date.now();
            const mockState = 'mock_state_' + Date.now();
            
            // Test URL parsing
            const testUrl = `https://dir.engageautomations.com/?code=${mockCode}&state=${mockState}`;
            const url = new URL(testUrl);
            const code = url.searchParams.get('code');
            const state = url.searchParams.get('state');
            
            const result = document.getElementById('callbackResult');
            
            if (code && state) {
                result.innerHTML = `
                    <div class="result success">
                        <strong>✓ Callback URL Parsing Works</strong><br>
                        <small>Code: ${code}</small><br>
                        <small>State: ${state}</small><br>
                        <small>URL: ${testUrl}</small>
                    </div>
                `;
            } else {
                result.innerHTML = `
                    <div class="result error">
                        <strong>✗ Callback URL Parsing Failed</strong><br>
                        <small>Code: ${code || 'missing'}</small><br>
                        <small>State: ${state || 'missing'}</small>
                    </div>
                `;
            }
        }
        
        async function testTokenExchange() {
            const result = document.getElementById('tokenResult');
            result.innerHTML = '<div class="result info">Testing token exchange endpoint...</div>';
            
            try {
                const response = await fetch('/api/oauth/exchange-local', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: 'test_code',
                        state: 'test_state',
                        redirect_uri: 'https://dir.engageautomations.com/'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="result success">
                            <strong>✓ Token Exchange Endpoint Accessible</strong><br>
                            <small>Status: ${response.status}</small><br>
                            <small>Response: ${JSON.stringify(data, null, 2)}</small>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="result error">
                            <strong>✗ Token Exchange Failed</strong><br>
                            <small>Status: ${response.status}</small><br>
                            <small>Error: ${data.error || 'Unknown error'}</small>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="result error">
                        <strong>✗ Token Exchange Endpoint Error</strong><br>
                        <small>Error: ${error.message}</small>
                    </div>
                `;
            }
        }
        
        function startLiveOAuth() {
            const clientId = '67472ecce8b57dd9eda067a8';
            const redirectUri = 'https://dir.engageautomations.com/';
            const state = 'live_test_' + Date.now();
            const scopes = [
                'products/prices.write',
                'products/prices.readonly', 
                'products/collection.write',
                'products/collection.readonly',
                'medias.write',
                'medias.readonly',
                'locations.readonly',
                'contacts.readonly',
                'contacts.write'
            ];
            
            localStorage.setItem('oauth_state', state);
            localStorage.setItem('oauth_test_mode', 'true');
            
            const authUrl = new URL('https://marketplace.leadconnectorhq.com/oauth/chooselocation');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', clientId);
            authUrl.searchParams.set('redirect_uri', redirectUri);
            authUrl.searchParams.set('scope', scopes.join(' '));
            authUrl.searchParams.set('state', state);
            
            const result = document.getElementById('liveResult');
            result.innerHTML = `
                <div class="result info">
                    <strong>Starting Live OAuth Flow...</strong><br>
                    <small>State stored: ${state}</small><br>
                    <small>Redirecting to GoHighLevel...</small>
                </div>
            `;
            
            // Redirect after a brief delay to show the message
            setTimeout(() => {
                window.location.href = authUrl.toString();
            }, 2000);
        }
        
        // Check if this is a callback from OAuth
        function checkForOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const testMode = localStorage.getItem('oauth_test_mode');
            
            if (testMode && (code || error)) {
                const result = document.createElement('div');
                result.className = 'test-section';
                result.innerHTML = `
                    <h3>OAuth Callback Result</h3>
                    <div class="result ${error ? 'error' : 'success'}">
                        <strong>${error ? '✗ OAuth Error' : '✓ OAuth Callback Received'}</strong><br>
                        <small>Code: ${code || 'none'}</small><br>
                        <small>State: ${state || 'none'}</small><br>
                        <small>Error: ${error || 'none'}</small><br>
                        <small>URL: ${window.location.href}</small>
                    </div>
                `;
                document.body.insertBefore(result, document.body.firstChild);
                localStorage.removeItem('oauth_test_mode');
            }
        }
        
        // Run callback check on page load
        checkForOAuthCallback();
    </script>
</body>
</html>