<!DOCTYPE html>
<html>
<head>
    <title>OAuth Data Test</title>
    <script>
        async function testOAuthData() {
            console.log('Testing OAuth data retrieval...');
            
            // Check local storage first
            const oauthSuccess = localStorage.getItem('oauth_success');
            const oauthTimestamp = localStorage.getItem('oauth_timestamp');
            
            console.log('Local OAuth Status:');
            console.log('- Success:', oauthSuccess);
            console.log('- Timestamp:', oauthTimestamp);
            
            if (oauthTimestamp) {
                const installTime = new Date(parseInt(oauthTimestamp));
                console.log('- Installation Date:', installTime.toISOString());
            }
            
            // Try to get user data from server
            try {
                const response = await fetch('/api/oauth/user-data', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('Server OAuth Data:', data);
                
                if (data.success && data.userInfo) {
                    document.getElementById('result').innerHTML = `
                        <h2>Marketplace Installation Data:</h2>
                        <p><strong>User ID:</strong> ${data.userInfo.id}</p>
                        <p><strong>Name:</strong> ${data.userInfo.name}</p>
                        <p><strong>Email:</strong> ${data.userInfo.email}</p>
                        <p><strong>Installation Time:</strong> ${data.installationTime || new Date(parseInt(oauthTimestamp)).toISOString()}</p>
                    `;
                } else {
                    document.getElementById('result').innerHTML = `
                        <h2>OAuth Status:</h2>
                        <p>Installation detected but user data not available</p>
                        <p>Error: ${data.error || 'Unknown error'}</p>
                    `;
                }
            } catch (error) {
                console.error('Error retrieving OAuth data:', error);
                document.getElementById('result').innerHTML = `
                    <h2>Installation Detected:</h2>
                    <p>Local storage shows successful OAuth completion</p>
                    <p>Timestamp: ${oauthTimestamp ? new Date(parseInt(oauthTimestamp)).toISOString() : 'Not available'}</p>
                    <p>Server data retrieval failed: ${error.message}</p>
                `;
            }
        }
        
        window.onload = testOAuthData;
    </script>
</head>
<body>
    <h1>OAuth Installation Data Test</h1>
    <div id="result">Loading...</div>
</body>
</html>