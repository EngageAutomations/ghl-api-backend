<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoHighLevel OAuth Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white rounded-lg shadow-md p-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">GoHighLevel OAuth Marketplace</h1>
                <div class="space-y-4">
                    <div class="p-4 bg-green-100 rounded-lg">
                        <p class="text-green-800 font-semibold">OAuth Backend: Operational</p>
                        <p class="text-green-600 text-sm">Railway v1.4.1-fixed</p>
                    </div>
                    
                    <div class="p-4 bg-blue-100 rounded-lg">
                        <p class="text-blue-800 font-semibold">Frontend: Ready</p>
                        <p class="text-blue-600 text-sm">Replit Application Server</p>
                    </div>
                    
                    <div class="space-y-2">
                        <button 
                            onclick="window.open('https://marketplace.leadconnectorhq.com/oauth/chooselocation?response_type=code&redirect_uri=https%3A%2F%2Fdir.engageautomations.com%2Fapi%2Foauth%2Fcallback&client_id=68474924a586bce22a6e64f7-mbpkmyu4&state=product_creation_test&scope=locations.readonly%20locations.write%20contacts.readonly%20contacts.write%20opportunities.readonly%20opportunities.write%20products/prices.write%20products/prices.readonly%20products/collection.write%20products/collection.readonly%20medias.write%20medias.readonly', '_blank')"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Complete OAuth Installation First
                        </button>
                        
                        <button 
                            onclick="checkOAuthStatus()"
                            class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors"
                        >
                            Check OAuth Status
                        </button>
                        
                        <button 
                            onclick="createProductWithPricing()"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            Multi-Step: Upload Image → Create Product → Add Price
                        </button>
                    </div>
                    
                    <div id="status" class="mt-4 p-3 bg-gray-100 rounded text-sm text-gray-600 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function checkOAuthStatus() {
            const status = document.getElementById('status');
            status.classList.remove('hidden');
            status.innerHTML = 'Checking OAuth status...';
            
            try {
                const response = await fetch('https://dir.engageautomations.com/installations');
                const data = await response.json();
                status.innerHTML = `OAuth Installations: ${data.total || 0}`;
            } catch (error) {
                status.innerHTML = 'Error checking OAuth status';
            }
        }
        
        async function createProductWithPricing() {
            const status = document.getElementById('status');
            status.classList.remove('hidden');
            status.innerHTML = 'Starting multi-step product creation...';
            
            try {
                // Check for OAuth installation
                const installResponse = await fetch('https://dir.engageautomations.com/installations');
                const installData = await installResponse.json();
                
                if (installData.total === 0) {
                    status.innerHTML = 'No OAuth installation found. Complete OAuth first.';
                    status.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded';
                    return;
                }
                
                const installationId = installData.installations[0].id;
                
                // Check backend capabilities
                const backendStatus = await fetch('https://dir.engageautomations.com/');
                const backendData = await backendStatus.json();
                
                if (!backendData.features.includes('media-upload')) {
                    status.innerHTML = 'Backend updating with media upload capabilities. Creating basic product...';
                    
                    // Create basic product without media upload
                    const basicProductData = {
                        installation_id: installationId,
                        name: "Digital Marketing Masterclass Pro",
                        description: "Professional digital marketing course with video tutorials and templates",
                        productType: "DIGITAL"
                    };
                    
                    const basicResponse = await fetch('https://dir.engageautomations.com/api/products/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(basicProductData)
                    });
                    
                    const basicResult = await basicResponse.json();
                    
                    if (basicResult.success) {
                        status.innerHTML = `Product created: ${basicResult.product.name}<br>Product ID: ${basicResult.product._id}<br>Status: Ready for images and pricing when backend completes deployment`;
                        status.className = 'mt-4 p-3 bg-blue-100 text-blue-800 rounded';
                    }
                    return;
                }
                
                // Complete multi-step workflow
                status.innerHTML = 'Step 1: Downloading product image...';
                
                // Download professional image
                const imageResponse = await fetch('https://images.unsplash.com/photo-1556740758-90de374c12ad?w=800&h=600&fit=crop&q=80');
                const imageBlob = await imageResponse.blob();
                
                status.innerHTML = 'Step 2: Uploading image to GoHighLevel media library...';
                
                // Upload to GoHighLevel
                const formData = new FormData();
                formData.append('file', imageBlob, 'course_image.jpg');
                formData.append('installation_id', installationId);
                
                const uploadResponse = await fetch('https://dir.engageautomations.com/api/media/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    status.innerHTML = `Image upload failed: ${uploadResult.error}`;
                    status.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded';
                    return;
                }
                
                status.innerHTML = 'Step 3: Creating product with uploaded image...';
                
                // Create product with GoHighLevel media URL
                const productData = {
                    installation_id: installationId,
                    name: "Premium Digital Marketing Masterclass 2025",
                    description: "Complete digital marketing course with 50+ HD video tutorials, downloadable templates, case studies, and bonus materials. Learn SEO, PPC, social media marketing, email automation, and conversion optimization.",
                    productType: "DIGITAL",
                    medias: [{ url: uploadResult.mediaUrl, type: 'image' }]
                };
                
                const productResponse = await fetch('https://dir.engageautomations.com/api/products/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                const productResult = await productResponse.json();
                
                if (!productResult.success) {
                    status.innerHTML = `Product creation failed: ${productResult.error}`;
                    status.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded';
                    return;
                }
                
                status.innerHTML = 'Step 4: Adding premium pricing...';
                
                // Add pricing
                const priceData = {
                    installation_id: installationId,
                    name: "Premium Lifetime Access",
                    type: "one_time",
                    amount: 39700, // $397.00
                    currency: "USD"
                };
                
                const priceResponse = await fetch(`https://dir.engageautomations.com/api/products/${productResult.product._id}/prices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(priceData)
                });
                
                const priceResult = await priceResponse.json();
                
                if (priceResult.success) {
                    status.innerHTML = `COMPLETE WORKFLOW SUCCESSFUL<br>
                        Product: ${productResult.product.name}<br>
                        Product ID: ${productResult.product._id}<br>
                        Image: Uploaded to GoHighLevel media library<br>
                        Price: $397.00 USD<br>
                        Status: Complete product with authentic GoHighLevel media and pricing`;
                    status.className = 'mt-4 p-3 bg-green-100 text-green-800 rounded';
                } else {
                    status.innerHTML = `Product created with image but pricing failed: ${priceResult.error}`;
                    status.className = 'mt-4 p-3 bg-yellow-100 text-yellow-800 rounded';
                }
                
            } catch (error) {
                status.innerHTML = `Error: ${error.message}`;
                status.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded';
            }
        }
        
        // Check for OAuth callback parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('oauth') === 'success') {
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('status').innerHTML = 'OAuth installation completed successfully!';
            document.getElementById('status').className = 'mt-4 p-3 bg-green-100 text-green-800 rounded';
        }
    </script>
</body>
</html>