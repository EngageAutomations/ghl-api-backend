<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real OAuth Data Capture</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            display: inline-block;
            text-decoration: none;
        }
        .button:hover {
            background-color: #005a87;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #007cba;
            background-color: #f0f8ff;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
            color: #dc3545;
        }
        .success {
            border-left-color: #28a745;
            background-color: #f0fff4;
            color: #28a745;
        }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real OAuth Account Data Capture Test</h1>
        <p>Test capturing and using real GoHighLevel account data for API calls.</p>
        
        <div id="status" class="status">
            <strong>Status:</strong> Ready to test OAuth data capture
        </div>
        
        <div class="test-grid">
            <div class="section">
                <h3>Step 1: Check Current Data</h3>
                <button id="checkData" class="button">Check Database for Real Account Data</button>
                <div id="currentData"></div>
            </div>
            
            <div class="section">
                <h3>Step 2: Test API Call</h3>
                <button id="testAPI" class="button">Test Media Upload API</button>
                <div id="apiResults"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>Step 3: Start Fresh OAuth (if needed)</h3>
            <button id="startOAuth" class="button">Start New OAuth Flow</button>
            <div id="oauthResults"></div>
        </div>
        
        <div class="section">
            <h3>OAuth Callback System Status</h3>
            <div id="callbackStatus" class="data-display">
                Checking OAuth callback configuration...
            </div>
        </div>
        
        <div id="allResults" style="margin-top: 20px;"></div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const allResultsDiv = document.getElementById('allResults');
        
        function updateStatus(message, type = 'info') {
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
            statusDiv.className = `status ${type}`;
        }
        
        function displayResults(elementId, title, data) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <h4>${title}</h4>
                <div class="data-display">${JSON.stringify(data, null, 2)}</div>
            `;
        }
        
        async function checkCurrentData() {
            try {
                updateStatus('Checking database for real OAuth account data...', 'info');
                
                const response = await fetch('/api/oauth/users');
                const data = await response.json();
                
                if (data.success && data.users && data.users.length > 0) {
                    const realUsers = data.users.filter(user => 
                        user.ghl_user_id && 
                        user.ghl_access_token && 
                        !user.ghl_user_id.includes('demo') &&
                        !user.ghl_access_token.includes('demo')
                    );
                    
                    if (realUsers.length > 0) {
                        updateStatus(`Found ${realUsers.length} real OAuth account(s)!`, 'success');
                        displayResults('currentData', 'Real Account Data Found', {
                            count: realUsers.length,
                            users: realUsers.map(user => ({
                                id: user.id,
                                email: user.email,
                                ghl_user_id: user.ghl_user_id,
                                ghl_location_id: user.ghl_location_id,
                                ghl_location_name: user.ghl_location_name,
                                has_access_token: !!user.ghl_access_token,
                                token_expiry: user.ghl_token_expiry,
                                scopes: user.ghl_scopes
                            }))
                        });
                    } else {
                        updateStatus('No real account data found - only demo/placeholder data', 'error');
                        displayResults('currentData', 'Current Database Content', data);
                    }
                } else {
                    updateStatus('No OAuth users found in database', 'error');
                    displayResults('currentData', 'Database Response', data);
                }
            } catch (error) {
                updateStatus(`Error checking data: ${error.message}`, 'error');
                displayResults('currentData', 'Error Details', { error: error.message });
            }
        }
        
        async function testAPICall() {
            try {
                updateStatus('Testing media upload API with real account data...', 'info');
                
                // First get the real OAuth data
                const usersResponse = await fetch('/api/oauth/users');
                const usersData = await usersResponse.json();
                
                if (!usersData.success || !usersData.users || usersData.users.length === 0) {
                    throw new Error('No OAuth users found - complete OAuth flow first');
                }
                
                const realUser = usersData.users.find(user => 
                    user.ghl_user_id && 
                    user.ghl_access_token && 
                    !user.ghl_user_id.includes('demo')
                );
                
                if (!realUser) {
                    throw new Error('No real account data found - only demo data available');
                }
                
                // Test the media list API
                const apiResponse = await fetch(`/api/ghl/medias?locationId=${realUser.ghl_location_id}&limit=5`, {
                    headers: {
                        'X-Installation-Id': realUser.id.toString()
                    }
                });
                
                const apiData = await apiResponse.json();
                
                if (apiData.success) {
                    updateStatus('API call successful with real account data!', 'success');
                    displayResults('apiResults', 'Media API Response', {
                        status: 'success',
                        location: realUser.ghl_location_name,
                        data: apiData.data
                    });
                } else {
                    updateStatus('API call failed', 'error');
                    displayResults('apiResults', 'API Error Response', apiData);
                }
                
            } catch (error) {
                updateStatus(`API test error: ${error.message}`, 'error');
                displayResults('apiResults', 'API Test Error', { error: error.message });
            }
        }
        
        async function startOAuthFlow() {
            try {
                updateStatus('Generating OAuth URL for fresh installation...', 'info');
                
                const response = await fetch('/oauth/callback?action=generate-url');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('OAuth URL generated - complete installation to capture real data', 'success');
                    displayResults('oauthResults', 'OAuth Installation URL', {
                        message: 'Click the link below to install the app and capture real account data',
                        authUrl: data.authUrl,
                        clientId: data.clientId,
                        redirectUri: data.redirectUri
                    });
                    
                    // Add clickable link
                    document.getElementById('oauthResults').innerHTML += `
                        <p><a href="${data.authUrl}" target="_blank" class="button">Complete OAuth Installation</a></p>
                        <p><em>After completing OAuth, refresh this page and check for real account data.</em></p>
                    `;
                } else {
                    updateStatus(`OAuth URL generation failed: ${data.error}`, 'error');
                    displayResults('oauthResults', 'OAuth Error', data);
                }
            } catch (error) {
                updateStatus(`OAuth flow error: ${error.message}`, 'error');
                displayResults('oauthResults', 'OAuth Flow Error', { error: error.message });
            }
        }
        
        async function checkCallbackStatus() {
            try {
                const response = await fetch('/oauth/callback');
                const text = await response.text();
                
                document.getElementById('callbackStatus').textContent = 
                    `OAuth callback endpoint: ${response.status} ${response.statusText}\n` +
                    `Response: ${text}`;
            } catch (error) {
                document.getElementById('callbackStatus').textContent = 
                    `Error checking callback: ${error.message}`;
            }
        }
        
        // Event listeners
        document.getElementById('checkData').addEventListener('click', checkCurrentData);
        document.getElementById('testAPI').addEventListener('click', testAPICall);
        document.getElementById('startOAuth').addEventListener('click', startOAuthFlow);
        
        // Auto-check status on load
        checkCallbackStatus();
        checkCurrentData();
    </script>
</body>
</html>