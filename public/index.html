<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoHighLevel Directory App</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 40px;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container { 
      max-width: 600px; 
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center; 
    }
    .btn { 
      background: #0079F2; 
      color: white; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 6px; 
      text-decoration: none; 
      display: inline-block; 
      margin: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover { background: #0066D9; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .success { color: #28a745; margin: 20px 0; }
    .error { color: #dc3545; margin: 20px 0; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0079F2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .oauth-connected {
      background: #28a745;
      padding: 20px;
      border-radius: 8px;
      color: white;
      margin: 20px 0;
    }
    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    .status.loading {
      background: #e3f2fd;
      color: #1976d2;
    }
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GoHighLevel Directory App</h1>
    <p>Connect your GoHighLevel account to get started.</p>
    <button onclick="startOAuth()" class="btn" id="oauthBtn">Connect with GoHighLevel</button>
    <div class="spinner" id="spinner"></div>
    <div id="status"></div>
  </div>

  <script>
    console.log('OAuth app initialized');
    
    // OAuth configuration
    const oauthConfig = {
      clientId: '67472ecce8b57dd9eda067a8',
      redirectUri: 'https://dir.engageautomations.com/',
      scopes: [
        'products/prices.write',
        'products/prices.readonly', 
        'products/collection.write',
        'products/collection.readonly',
        'medias.write',
        'medias.readonly',
        'locations.readonly',
        'contacts.readonly',
        'contacts.write'
      ]
    };

    // Check for OAuth callback on page load
    function checkOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const oauthSuccess = urlParams.get('oauth') === 'success';
      const storedSuccess = localStorage.getItem('oauth_success') === 'true';
      
      console.log('Checking OAuth status:', { code: !!code, state, error, oauthSuccess, storedSuccess });
      
      if (error) {
        showError(`OAuth error: ${error}`);
        return;
      }
      
      if (code && state) {
        handleOAuthCallback(code, state);
        return;
      }
      
      if (oauthSuccess || storedSuccess) {
        showOAuthSuccess();
        return;
      }
    }

    // Start OAuth flow
    function startOAuth() {
      console.log('Starting OAuth flow...');
      
      const state = `oauth_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const scope = oauthConfig.scopes.join(' ');
      
      // Store state for validation
      localStorage.setItem('oauth_state', state);
      
      // Build OAuth URL
      const authUrl = new URL('https://marketplace.gohighlevel.com/oauth/chooselocation');
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('client_id', oauthConfig.clientId);
      authUrl.searchParams.set('redirect_uri', oauthConfig.redirectUri);
      authUrl.searchParams.set('scope', scope);
      authUrl.searchParams.set('state', state);
      
      console.log('Redirecting to:', authUrl.toString());
      
      // Show loading state
      showLoading('Redirecting to GoHighLevel...');
      
      // Redirect to OAuth
      window.location.href = authUrl.toString();
    }

    // Handle OAuth callback
    async function handleOAuthCallback(code, state) {
      console.log('Handling OAuth callback');
      
      // Validate state
      const storedState = localStorage.getItem('oauth_state');
      if (state !== storedState) {
        showError('Invalid OAuth state. Please try again.');
        return;
      }
      
      showLoading('Processing authorization...');
      
      try {
        // Exchange code for tokens using your backend
        const response = await fetch('https://oauth-backend-production-68c5.up.railway.app/api/oauth/exchange', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code: code,
            state: state,
            redirect_uri: oauthConfig.redirectUri
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Store success state
          localStorage.setItem('oauth_success', 'true');
          localStorage.setItem('oauth_timestamp', Date.now().toString());
          localStorage.removeItem('oauth_state');
          
          // Clear URL parameters and show success
          window.history.replaceState({}, document.title, window.location.pathname);
          showOAuthSuccess();
        } else {
          throw new Error(result.error || 'Token exchange failed');
        }
        
      } catch (error) {
        console.error('OAuth exchange error:', error);
        showError(`Authorization failed: ${error.message}`);
      }
    }

    // Show loading state
    function showLoading(message) {
      document.getElementById('spinner').style.display = 'block';
      document.getElementById('oauthBtn').disabled = true;
      document.getElementById('status').innerHTML = `<div class="status loading">${message}</div>`;
    }

    // Show OAuth success state
    function showOAuthSuccess() {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('oauthBtn').style.display = 'none';
      document.getElementById('status').innerHTML = `
        <div class="oauth-connected">
          <h3>âœ“ Successfully Connected!</h3>
          <p>Your GoHighLevel account is now connected. You can start creating directory listings.</p>
          <button onclick="goToDashboard()" class="btn" style="background: white; color: #28a745; margin-top: 10px;">
            Go to Dashboard
          </button>
        </div>
      `;
    }

    // Show error message
    function showError(message) {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('oauthBtn').disabled = false;
      document.getElementById('status').innerHTML = `<div class="status error"><strong>Error:</strong> ${message}</div>`;
    }

    // Navigate to dashboard
    function goToDashboard() {
      alert('Dashboard functionality will be implemented here. OAuth integration is complete!');
    }

    // Reset OAuth state
    function resetOAuth() {
      localStorage.removeItem('oauth_success');
      localStorage.removeItem('oauth_timestamp');
      localStorage.removeItem('oauth_state');
      window.location.reload();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', checkOAuthCallback);
    
    // Also check immediately in case DOMContentLoaded already fired
    checkOAuthCallback();
  </script>
</body>
</html>