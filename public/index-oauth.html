<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoHighLevel Directory App</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 40px;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container { 
      max-width: 600px; 
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center; 
    }
    .btn { 
      background: #0079F2; 
      color: white; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 6px; 
      text-decoration: none; 
      display: inline-block; 
      margin: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover { background: #0066D9; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .success { color: #28a745; margin: 20px 0; }
    .error { color: #dc3545; margin: 20px 0; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0079F2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .oauth-connected {
      background: #28a745;
      padding: 20px;
      border-radius: 8px;
      color: white;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GoHighLevel Directory App</h1>
    <p>Connect your GoHighLevel account to get started.</p>
    <button onclick="startOAuth()" class="btn" id="oauthBtn">Connect with GoHighLevel</button>
    <div class="spinner" id="spinner"></div>
    <div id="status"></div>
  </div>

  <script>
    console.log('OAuth app loaded');
    
    // OAuth configuration
    const oauthConfig = {
      clientId: 'YOUR_CLIENT_ID', // This will be set from environment
      redirectUri: 'https://dir.engageautomations.com/oauth-success',
      scopes: [
        'products/prices.write',
        'products/prices.readonly', 
        'products/collection.write',
        'products/collection.readonly',
        'medias.write',
        'medias.readonly',
        'locations.readonly',
        'contacts.readonly',
        'contacts.write'
      ]
    };

    // Check for OAuth success on page load
    function checkOAuthStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const oauthSuccess = urlParams.get('oauth') === 'success';
      const storedSuccess = localStorage.getItem('oauth_success') === 'true';
      
      if (oauthSuccess || storedSuccess) {
        showOAuthSuccess();
      }
    }

    // Start OAuth flow
    function startOAuth() {
      console.log('Starting OAuth flow');
      
      const state = `oauth_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const scope = oauthConfig.scopes.join(' ');
      
      // Store state for validation
      localStorage.setItem('oauth_state', state);
      
      // Build OAuth URL
      const authUrl = new URL('https://marketplace.gohighlevel.com/oauth/chooselocation');
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('redirect_uri', oauthConfig.redirectUri);
      authUrl.searchParams.set('scope', scope);
      authUrl.searchParams.set('state', state);
      
      // Use environment client ID or fallback
      const clientId = getClientId();
      if (clientId) {
        authUrl.searchParams.set('client_id', clientId);
      } else {
        showError('OAuth configuration not found. Please contact support.');
        return;
      }
      
      console.log('Redirecting to OAuth URL:', authUrl.toString());
      
      // Show loading state
      document.getElementById('spinner').style.display = 'block';
      document.getElementById('oauthBtn').disabled = true;
      document.getElementById('status').innerHTML = 'Redirecting to GoHighLevel...';
      
      // Redirect to OAuth
      window.location.href = authUrl.toString();
    }

    // Get client ID from environment or configuration
    function getClientId() {
      // In production, this should come from your backend configuration
      // For now, returning the actual client ID from environment
      return '67472ecce8b57dd9eda067a8'; // Your GHL client ID
    }

    // Show OAuth success state
    function showOAuthSuccess() {
      document.getElementById('status').innerHTML = `
        <div class="oauth-connected">
          <h3>âœ“ Successfully Connected!</h3>
          <p>Your GoHighLevel account is now connected. You can start creating directory listings.</p>
          <button onclick="goToDashboard()" class="btn" style="background: white; color: #28a745; margin-top: 10px;">
            Go to Dashboard
          </button>
        </div>
      `;
      document.getElementById('oauthBtn').style.display = 'none';
    }

    // Show error message
    function showError(message) {
      document.getElementById('status').innerHTML = `
        <div class="error">
          <strong>Error:</strong> ${message}
        </div>
      `;
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('oauthBtn').disabled = false;
    }

    // Navigate to dashboard (placeholder)
    function goToDashboard() {
      // Placeholder for dashboard navigation
      alert('Dashboard functionality will be implemented here.');
    }

    // Check OAuth status on page load
    document.addEventListener('DOMContentLoaded', checkOAuthStatus);
    
    // Also check immediately in case DOMContentLoaded already fired
    checkOAuthStatus();
  </script>
</body>
</html>