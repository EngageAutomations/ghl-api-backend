# Complete Redirect URI Configuration Guide

## GoHighLevel Marketplace Configuration

### App Settings Dashboard
**Location:** GoHighLevel Developer Portal → Your App → OAuth Settings

**Required Configuration:**
```
Redirect URI: https://dir.engageautomations.com/api/oauth/callback
Client ID: 68474924a586bce22a6e64f7-mbpkmyu4
Client Secret: [Generated by GoHighLevel - Store securely]
```

**Authorized Scopes:**
```
locations.readonly
locations.write
contacts.readonly
contacts.write
opportunities.readonly
opportunities.write
calendars.readonly
calendars.write
forms.readonly
forms.write
surveys.readonly
surveys.write
workflows.readonly
workflows.write
snapshots.readonly
snapshots.write
products/prices.write
products/prices.readonly
products/collection.write
products/collection.readonly
medias.write
medias.readonly
```

## Railway Backend Configuration

### Environment Variables Setup
**Location:** Railway Dashboard → Project → Variables Tab

**Required Variables:**
```bash
GHL_CLIENT_ID=68474924a586bce22a6e64f7-mbpkmyu4
GHL_CLIENT_SECRET=[Your GoHighLevel client secret]
GHL_REDIRECT_URI=https://dir.engageautomations.com/api/oauth/callback
NODE_ENV=production
PORT=5000
```

### Domain Configuration
**Railway Domain:** `dir.engageautomations.com`
**Backend Endpoints:**
- Health Check: `https://dir.engageautomations.com/health`
- OAuth Callback: `https://dir.engageautomations.com/api/oauth/callback`
- Installation Details: `https://dir.engageautomations.com/api/installations/latest`
- Universal API: `https://dir.engageautomations.com/api/ghl/*`

## OAuth Flow URL Structure

### Authorization Flow
1. **Initial Authorization:**
   ```
   https://marketplace.leadconnectorhq.com/oauth/chooselocation?
     response_type=code&
     redirect_uri=https://dir.engageautomations.com/api/oauth/callback&
     client_id=68474924a586bce22a6e64f7-mbpkmyu4&
     state=[unique_state]&
     scope=[encoded_scopes]
   ```

2. **Token Exchange:**
   ```
   POST https://services.leadconnectorhq.com/oauth/token
   Content-Type: application/x-www-form-urlencoded
   
   grant_type=authorization_code&
   client_id=68474924a586bce22a6e64f7-mbpkmyu4&
   client_secret=[secret]&
   code=[auth_code]&
   redirect_uri=https://dir.engageautomations.com/api/oauth/callback
   ```

3. **User Info Retrieval:**
   ```
   GET https://services.leadconnectorhq.com/oauth/userinfo
   Authorization: Bearer [access_token]
   Version: 2021-07-28
   ```

### Success/Error Redirects
**Success Redirect (Replit App):**
```
https://listings.engageautomations.com/oauth-success?
  success=true&
  timestamp=[timestamp]&
  locationId=[location_id]&
  installationId=[installation_id]
```

**Error Redirect (Replit App):**
```
https://listings.engageautomations.com/oauth-error?
  error=[error_description]
```

## Replit App Configuration (To Restore)

### Domain Setup
**Replit Domain:** `listings.engageautomations.com`
**Frontend Endpoints:**
- OAuth Success Page: `https://listings.engageautomations.com/oauth-success`
- OAuth Error Page: `https://listings.engageautomations.com/oauth-error`
- Main Application: `https://listings.engageautomations.com/`

### Environment Variables for Replit
```bash
GHL_ACCESS_TOKEN=[From Railway installation data]
GHL_LOCATION_ID=WAVk87RmW9rBSDJHeOpH
GHL_REFRESH_TOKEN=[From Railway installation data]
GHL_INSTALLATION_ID=1
VITE_RAILWAY_API_URL=https://dir.engageautomations.com
```

## Installation Data Structure

### Captured Installation Data
```json
{
  "id": 1,
  "ghlUserId": "user_1749919362702",
  "ghlLocationId": "WAVk87RmW9rBSDJHeOpH",
  "ghlAccessToken": "[jwt_access_token]",
  "ghlRefreshToken": "[jwt_refresh_token]",
  "ghlTokenType": "Bearer",
  "ghlExpiresIn": 3600,
  "ghlScopes": "products/prices.write products/prices.readonly...",
  "installationDate": "2025-06-14T16:42:42.702Z",
  "isActive": true
}
```

### Access Token Format
```json
{
  "authClass": "Location",
  "authClassId": "WAVk87RmW9rBSDJHeOpH",
  "source": "INTEGRATION",
  "sourceId": "68474924a586bce22a6e64f7-mbpkmyu4",
  "channel": "OAUTH",
  "primaryAuthClassId": "WAVk87RmW9rBSDJHeOpH",
  "oauthMeta": {
    "scopes": ["products/prices.write", "medias.write", "..."],
    "client": "68474924a586bce22a6e64f7",
    "clientKey": "68474924a586bce22a6e64f7-mbpkmyu4"
  },
  "iat": 1749919362.458,
  "exp": 1750005762.458
}
```

## Testing and Verification

### Railway Backend Health Check
```bash
curl https://dir.engageautomations.com/health
```

Expected Response:
```json
{
  "status": "OK",
  "service": "Universal GHL API Backend",
  "timestamp": "2025-06-14T16:42:42.418Z",
  "installationsCount": 1,
  "supportedEndpoints": 39
}
```

### Installation Verification
```bash
curl https://dir.engageautomations.com/api/installations/latest
```

Expected Response:
```json
{
  "success": true,
  "installation": {
    "id": 1,
    "ghlLocationId": "WAVk87RmW9rBSDJHeOpH",
    "ghlAccessToken": "[token]",
    "installationDate": "2025-06-14T16:42:42.702Z",
    "isActive": true
  }
}
```

## Security Considerations

### Environment Variable Security
- Store client secret securely in Railway environment variables
- Never commit secrets to version control
- Use HTTPS for all OAuth redirects
- Validate state parameter to prevent CSRF attacks

### CORS Configuration
```javascript
cors({
  origin: [
    'https://listings.engageautomations.com',
    'https://dir.engageautomations.com',
    'http://localhost:3000'
  ],
  credentials: true
})
```

### Token Management
- Access tokens expire in 24 hours
- Refresh tokens valid for 1 year
- Implement automatic token refresh logic
- Store tokens securely with encryption

## Troubleshooting Common Issues

### Redirect URI Mismatch
**Error:** "redirect_uri_mismatch"
**Solution:** Ensure exact match between GoHighLevel app settings and Railway configuration

### Invalid Client ID
**Error:** "invalid_client"
**Solution:** Verify client ID matches GoHighLevel app registration

### Scope Permission Denied
**Error:** "insufficient_scope"
**Solution:** Request required scopes in GoHighLevel app settings

### Token Expired
**Error:** "token_expired"
**Solution:** Use refresh token to obtain new access token

This configuration is currently verified and working with Installation ID 1 capturing real GoHighLevel credentials.